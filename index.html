<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calendario Genio Visión</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --bg: #0f172a;
      --bg-soft: #111827;
      --accent: #22c55e;
      --accent-soft: #16a34a;
      --danger: #ef4444;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --border: #1f2937;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1e293b, #020617);
      color: var(--text);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      max-width: 1200px;
      width: 100%;
      padding: 16px;
    }

    .card {
      background: linear-gradient(145deg, #020617, #020617, #020617);
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.15);
      padding: 20px;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: #e5e7eb;
      text-shadow: 0 0 20px rgba(37, 99, 235, 0.8);
    }

    .subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .week-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .week-info span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.78rem;
      background: rgba(37, 99, 235, 0.15);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(37, 99, 235, 0.4);
      color: #bfdbfe;
    }

    .controls-top {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.82rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      white-space: nowrap;
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
    }

    button.primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), #1e40af);
      transform: translateY(-1px);
      box-shadow: 0 16px 35px rgba(37, 99, 235, 0.6);
    }

    button.secondary {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-soft);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    button.secondary:hover {
      background: rgba(148, 163, 184, 0.18);
      transform: translateY(-1px);
    }

    button.danger {
      background: rgba(239, 68, 68, 0.14);
      color: #fecaca;
      border: 1px solid rgba(239, 68, 68, 0.6);
    }

    button.danger:hover {
      background: rgba(239, 68, 68, 0.22);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .table-wrapper {
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: rgba(15, 23, 42, 0.95);
    }

    .table-scroll {
      max-height: 420px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 860px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: rgba(15, 23, 42, 0.98);
      box-shadow: 0 1px 0 rgba(30, 64, 175, 0.7);
    }

    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.85);
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-soft);
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.8);
    }

    tr:hover td {
      background: rgba(30, 64, 175, 0.22);
    }

    .student-name-input {
      width: 100%;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.9);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 0.82rem;
      color: var(--text);
      outline: none;
    }

    .student-name-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.6);
    }

    .day-cell {
      min-width: 140px;
    }

    .day-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .day-title {
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    .day-date {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .attendance-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .attendance-row {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, input[type="time"], input[type="date"] {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 6px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 4px 6px;
      font-size: 0.78rem;
      color: var(--text);
      outline: none;
    }

    select:focus, input[type="time"]:focus, input[type="date"]:focus {
      border-color: var(--primary);
    }

    .status-select {
      min-width: 90px;
    }

    .time-input {
      width: 80px;
    }

    .paid-col {
      min-width: 100px;
    }

    .pay-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      cursor: pointer;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      transition: all 0.15s;
    }

    .pay-chip.active {
      background: rgba(34, 197, 94, 0.16);
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
    }

    .pay-chip.pending {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .amount-select {
      min-width: 100px;
    }

    .row-actions {
      display: flex;
      gap: 6px;
    }

    .tiny-btn {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.85);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      font-size: 0.7rem;
      cursor: pointer;
    }

    .tiny-btn:hover {
      background: rgba(30, 64, 175, 0.4);
      color: #e5e7eb;
    }

    .footer-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(30, 64, 175, 0.6);
    }

    .history {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), #020617 60%);
      max-height: 260px;
      overflow: auto;
      font-size: 0.8rem;
    }

    .history-title {
      font-size: 0.84rem;
      color: var(--text-soft);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .history-item {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      padding: 7px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 0.95);
      margin-bottom: 6px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }

    .history-item:hover {
      background: rgba(30, 64, 175, 0.24);
      border-color: rgba(59, 130, 246, 0.7);
    }

    .history-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .history-week-label {
      font-weight: 600;
      color: #e5e7eb;
    }

    .history-sub {
      color: var(--text-soft);
      font-size: 0.78rem;
    }

    .history-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(75, 85, 99, 0.8);
      color: var(--text-soft);
    }

    .pill.green {
      border-color: rgba(34, 197, 94, 0.9);
      color: #bbf7d0;
    }

    .pill.red {
      border-color: rgba(239, 68, 68, 0.9);
      color: #fecaca;
    }

    .week-nav {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      font-size: 0.78rem;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.3rem;
      }
      .header {
        align-items: flex-start;
      }
      .table-wrapper {
        border-radius: 10px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <div class="header">
      <div class="title-block">
        <h1>Calendario Genio Visión</h1>
        <p class="subtitle">
          Control semanal de asistencia y pagos por estudiante (5 € / 6 €).
        </p>
      </div>
      <div class="week-info">
        <span>
          Semana actual:
          <strong id="weekLabel"></strong>
        </span>
        <span class="badge">
          <span style="font-size:10px;">●</span>
          Guardado automático en este dispositivo
        </span>
      </div>
    </div>

    <div class="controls-top">
      <button class="primary" id="addStudentBtn">+ Agregar estudiante</button>
      <button class="secondary" id="autoDatesBtn">Auto-fechas de la semana</button>
      <button class="secondary" id="clearWeekBtn">Limpiar semana actual</button>
    </div>

    <div class="table-wrapper">
      <div class="table-scroll">
        <table>
          <thead>
          <tr>
            <th>Estudiante</th>
            <th class="day-cell">
              <div class="day-header">
                <span class="day-title">Lunes</span>
                <span class="day-date" id="dateHeaderMon"></span>
              </div>
            </th>
            <th class="day-cell">
              <div class="day-header">
                <span class="day-title">Martes</span>
                <span class="day-date" id="dateHeaderTue"></span>
              </div>
            </th>
            <th class="day-cell">
              <div class="day-header">
                <span class="day-title">Miércoles</span>
                <span class="day-date" id="dateHeaderWed"></span>
              </div>
            </th>
            <th class="day-cell">
              <div class="day-header">
                <span class="day-title">Jueves</span>
                <span class="day-date" id="dateHeaderThu"></span>
              </div>
            </th>
            <th class="day-cell">
              <div class="day-header">
                <span class="day-title">Viernes</span>
                <span class="day-date" id="dateHeaderFri"></span>
              </div>
            </th>
            <th class="paid-col">Pagado</th>
            <th>Monto</th>
            <th>Acciones</th>
          </tr>
          </thead>
          <tbody id="studentsBody">
          <!-- Filas dinámicas -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="footer-bar">
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
        <button class="primary" id="saveWeekBtn">Guardar semana</button>
        <button class="secondary" id="newWeekBtn">Iniciar nueva semana</button>
      </div>
      <div style="font-size:0.78rem;color:var(--text-soft);text-align:right;">
        - Marque asistencia, horarios, pagado/pendiente y monto para cada niño.<br>
        - Las semanas anteriores quedan en el historial con opción de editar pagos atrasados.
      </div>
    </div>

    <div class="history">
      <div class="history-title">
        <span>Historial de semanas</span>
        <button class="tiny-btn" id="deleteAllBtn">Borrar todo el historial</button>
      </div>
      <ul class="history-list" id="historyList"></ul>
    </div>
  </div>
</div>

<script>
  // ====== Utilidades de fechas ======
  function getMonday(d) {
    const date = new Date(d);
    const day = date.getDay();
    const diff = day === 0 ? -6 : 1 - day;
    date.setDate(date.getDate() + diff);
    date.setHours(0, 0, 0, 0);
    return date;
  }

  function formatDateShort(d) {
    return d.toLocaleDateString("es-ES", {
      day: "2-digit",
      month: "2-digit"
    });
  }

  function formatFullDate(d) {
    return d.toLocaleDateString("es-ES", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric"
    });
  }

  function weekKeyFromMonday(mondayDate) {
    const d = new Date(mondayDate);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  // ====== Estructura de datos ======
  // weekData = {
  //   weekKey: "YYYY-MM-DD" (lunes),
  //   mondayDate: string,
  //   days: [dateLunes..dateViernes],
  //   students: [
  //     {
  //       id,
  //       name,
  //       amount: 5 | 6,
  //       paid: true/false,
  //       attendance: [
  //         {date, status, inTime, outTime} * 5
  //       ]
  //     }
  //   ]
  // }

  let currentWeekKey = null;
  let weekData = null;

  const STORAGE_KEY = "calendario-genio-vision-weeks";

  function loadAllWeeks() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return {};
    try {
      return JSON.parse(raw);
    } catch (e) {
      return {};
    }
  }

  function saveAllWeeks(allWeeks) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allWeeks));
  }

  function saveCurrentWeek() {
    if (!weekData || !currentWeekKey) return;
    const allWeeks = loadAllWeeks();
    allWeeks[currentWeekKey] = weekData;
    saveAllWeeks(allWeeks);
    renderHistory();
  }

  function createEmptyWeek(baseDate) {
    const monday = getMonday(baseDate || new Date());
    const days = [];
    for (let i = 0; i < 5; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      days.push(d.toISOString());
    }
    currentWeekKey = weekKeyFromMonday(monday);
    weekData = {
      weekKey: currentWeekKey,
      mondayDate: monday.toISOString(),
      days,
      students: []
    };
  }

  function setWeekHeaders() {
    if (!weekData) return;
    const [mon, tue, wed, thu, fri] = weekData.days.map(d => new Date(d));
    document.getElementById("dateHeaderMon").textContent = formatDateShort(mon);
    document.getElementById("dateHeaderTue").textContent = formatDateShort(tue);
    document.getElementById("dateHeaderWed").textContent = formatDateShort(wed);
    document.getElementById("dateHeaderThu").textContent = formatDateShort(thu);
    document.getElementById("dateHeaderFri").textContent = formatDateShort(fri);

    const startLabel = formatFullDate(mon);
    const endLabel = formatFullDate(fri);
    document.getElementById("weekLabel").textContent = `${startLabel} a ${endLabel}`;
  }

  function renderStudents() {
    const tbody = document.getElementById("studentsBody");
    tbody.innerHTML = "";

    if (!weekData) return;

    weekData.students.forEach(student => {
      const tr = document.createElement("tr");

      // Columna nombre
      const tdName = document.createElement("td");
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.className = "student-name-input";
      nameInput.placeholder = "Nombre del niño";
      nameInput.value = student.name || "";
      nameInput.addEventListener("input", () => {
        student.name = nameInput.value;
        saveCurrentWeek();
      });
      tdName.appendChild(nameInput);
      tr.appendChild(tdName);

      // Columnas de días
      for (let i = 0; i < 5; i++) {
        const att = student.attendance[i];
        const tdDay = document.createElement("td");
        tdDay.className = "day-cell";
        const block = document.createElement("div");
        block.className = "attendance-block";

        const row1 = document.createElement("div");
        row1.className = "attendance-row";

        const statusSelect = document.createElement("select");
        statusSelect.className = "status-select";
        ["", "Asistió", "No asistió"].forEach(optVal => {
          const opt = document.createElement("option");
          opt.value = optVal;
          opt.textContent = optVal === "" ? "Estado" : optVal;
          statusSelect.appendChild(opt);
        });
        statusSelect.value = att.status || "";
        statusSelect.addEventListener("change", () => {
          att.status = statusSelect.value;
          saveCurrentWeek();
        });

        const inTime = document.createElement("input");
        inTime.type = "time";
        inTime.className = "time-input";
        inTime.value = att.inTime || "";
        inTime.addEventListener("change", () => {
          att.inTime = inTime.value;
          saveCurrentWeek();
        });

        const outTime = document.createElement("input");
        outTime.type = "time";
        outTime.className = "time-input";
        outTime.value = att.outTime || "";
        outTime.addEventListener("change", () => {
          att.outTime = outTime.value;
          saveCurrentWeek();
        });

        row1.appendChild(statusSelect);
        row1.appendChild(inTime);
        row1.appendChild(outTime);
        block.appendChild(row1);
        tdDay.appendChild(block);
        tr.appendChild(tdDay);
      }

      // Pagado
      const tdPaid = document.createElement("td");
      tdPaid.className = "paid-col";
      const payBtn = document.createElement("div");
      payBtn.className = "pay-chip" + (student.paid ? " active" : " pending");
      payBtn.textContent = student.paid ? "Pagado" : "Pendiente";
      payBtn.addEventListener("click", () => {
        student.paid = !student.paid;
        payBtn.textContent = student.paid ? "Pagado" : "Pendiente";
        payBtn.className = "pay-chip" + (student.paid ? " active" : " pending");
        saveCurrentWeek();
      });
      tdPaid.appendChild(payBtn);
      tr.appendChild(tdPaid);

      // Monto
      const tdAmount = document.createElement("td");
      const amountSelect = document.createElement("select");
      amountSelect.className = "amount-select";
      [5, 6].forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val + " €";
        amountSelect.appendChild(opt);
      });
      amountSelect.value = student.amount || 5;
      amountSelect.addEventListener("change", () => {
        student.amount = parseInt(amountSelect.value, 10);
        saveCurrentWeek();
      });
      tdAmount.appendChild(amountSelect);
      tr.appendChild(tdAmount);

      // Acciones
      const tdActions = document.createElement("td");
      const actions = document.createElement("div");
      actions.className = "row-actions";

      const dupBtn = document.createElement("button");
      dupBtn.className = "tiny-btn";
      dupBtn.textContent = "Duplicar";
      dupBtn.addEventListener("click", () => {
        const copy = JSON.parse(JSON.stringify(student));
        copy.id = "s-" + Date.now() + "-" + Math.random().toString(16).slice(2);
        weekData.students.push(copy);
        renderStudents();
        saveCurrentWeek();
      });

      const delBtn = document.createElement("button");
      delBtn.className = "tiny-btn";
      delBtn.textContent = "Eliminar";
      delBtn.addEventListener("click", () => {
        if (!confirm("¿Eliminar este estudiante de la semana?")) return;
        weekData.students = weekData.students.filter(s => s.id !== student.id);
        renderStudents();
        saveCurrentWeek();
      });

      actions.appendChild(dupBtn);
      actions.appendChild(delBtn);
      tdActions.appendChild(actions);
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    });
  }

  function renderHistory() {
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    const allWeeks = loadAllWeeks();
    const entries = Object.values(allWeeks).sort((a, b) =>
      new Date(b.mondayDate) - new Date(a.mondayDate)
    );

    entries.forEach(w => {
      const li = document.createElement("li");
      li.className = "history-item";

      const main = document.createElement("div");
      main.className = "history-main";
      const mon = new Date(w.mondayDate);
      const fri = new Date(mon);
      fri.setDate(mon.getDate() + 4);

      const label = document.createElement("span");
      label.className = "history-week-label";
      label.textContent =
        formatFullDate(mon) + " → " + formatFullDate(fri);

      const sub = document.createElement("span");
      sub.className = "history-sub";
      const totalStudents = w.students.length;
      const paidCount = w.students.filter(s => s.paid).length;
      const pendingCount = totalStudents - paidCount;
      sub.textContent =
        "Estudiantes: " +
        totalStudents +
        " | Pagados: " +
        paidCount +
        " | Pendientes: " +
        pendingCount;

      main.appendChild(label);
      main.appendChild(sub);

      const badges = document.createElement("div");
      badges.className = "history-badges";

      const pillPaid = document.createElement("span");
      pillPaid.className = "pill green";
      pillPaid.textContent = "Pagos OK: " + paidCount;

      const pillPend = document.createElement("span");
      pillPend.className = "pill red";
      pillPend.textContent = "Pendientes: " + pendingCount;

      badges.appendChild(pillPaid);
      badges.appendChild(pillPend);

      const nav = document.createElement("div");
      nav.className = "week-nav";
      const loadBtn = document.createElement("button");
      loadBtn.className = "tiny-btn";
      loadBtn.textContent = "Cargar semana";
      loadBtn.addEventListener("click", e => {
        e.stopPropagation();
        loadWeek(w.weekKey);
      });

      nav.appendChild(loadBtn);

      li.appendChild(main);
      li.appendChild(badges);
      li.appendChild(nav);

      li.addEventListener("click", () => loadWeek(w.weekKey));

      list.appendChild(li);
    });
  }

  function loadWeek(key) {
    const allWeeks = loadAllWeeks();
    if (!allWeeks[key]) return;
    currentWeekKey = key;
    weekData = allWeeks[key];
    setWeekHeaders();
    renderStudents();
  }

  function addStudent() {
    const newStudent = {
      id: "s-" + Date.now() + "-" + Math.random().toString(16).slice(2),
      name: "",
      amount: 5,
      paid: false,
      attendance: weekData.days.map(d => ({
        date: d,
        status: "",
        inTime: "",
        outTime: ""
      }))
    };
    weekData.students.push(newStudent);
    renderStudents();
    saveCurrentWeek();
  }

  function autoFillWeekDates() {
    if (!weekData) return;
    const monday = getMonday(new Date());
    weekData.mondayDate = monday.toISOString();
    weekData.days = [];
    for (let i = 0; i < 5; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      weekData.days.push(d.toISOString());
    }
    if (weekData.students) {
      weekData.students.forEach(st => {
        st.attendance = weekData.days.map((d, idx) => {
          const prev = st.attendance[idx] || {};
          return {
            date: d,
            status: prev.status || "",
            inTime: prev.inTime || "",
            outTime: prev.outTime || ""
          };
        });
      });
    }
    setWeekHeaders();
    renderStudents();
    saveCurrentWeek();
  }

  function clearCurrentWeek() {
    if (!weekData) return;
    if (!confirm("Esto limpiará todos los datos de la semana actual (asistencia y pagos), ¿continuar?")) return;
    weekData.students.forEach(st => {
      st.paid = false;
      st.attendance.forEach(att => {
        att.status = "";
        att.inTime = "";
        att.outTime = "";
      });
    });
    renderStudents();
    saveCurrentWeek();
  }

  function startNewWeek() {
    if (!confirm("Se guardará la semana actual y se creará una nueva. ¿Continuar?")) return;
    saveCurrentWeek();
    createEmptyWeek(new Date());
    setWeekHeaders();
    renderStudents();
    saveCurrentWeek();
  }

  function init() {
    const allWeeks = loadAllWeeks();
    const todayMonday = getMonday(new Date());
    const todayKey = weekKeyFromMonday(todayMonday);

    if (allWeeks[todayKey]) {
      currentWeekKey = todayKey;
      weekData = allWeeks[todayKey];
    } else {
      createEmptyWeek(new Date());
    }

    setWeekHeaders();
    renderStudents();
    renderHistory();

    document.getElementById("addStudentBtn").addEventListener("click", addStudent);
    document.getElementById("autoDatesBtn").addEventListener("click", autoFillWeekDates);
    document.getElementById("clearWeekBtn").addEventListener("click", clearCurrentWeek);
    document.getElementById("saveWeekBtn").addEventListener("click", saveCurrentWeek);
    document.getElementById("newWeekBtn").addEventListener("click", startNewWeek);
    document.getElementById("deleteAllBtn").addEventListener("click", () => {
      if (!confirm("¿Borrar TODO el historial de semanas? Esta acción no se puede deshacer.")) return;
      localStorage.removeItem(STORAGE_KEY);
      createEmptyWeek(new Date());
      setWeekHeaders();
      renderStudents();
      renderHistory();
    });
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
